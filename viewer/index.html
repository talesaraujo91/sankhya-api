<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sankhya API Relationship Map</title>
    <script src="https://unpkg.com/cytoscape@3.31.0/dist/cytoscape.min.js"></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }

      .layout {
        display: grid;
        grid-template-columns: 1fr 420px;
        height: 100%;
      }

      #cy {
        height: 100%;
        width: 100%;
        background: #0b1020;
      }

      .panel {
        border-left: 1px solid #e5e7eb;
        padding: 14px;
        overflow: auto;
        background: white;
      }

      .title {
        font-weight: 700;
        font-size: 14px;
        margin: 0 0 8px;
      }

      .muted {
        color: #6b7280;
        font-size: 12px;
      }

      .kv {
        font-size: 12px;
        margin: 8px 0;
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid #e5e7eb;
        margin-right: 6px;
      }

      .code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        background: #f3f4f6;
        padding: 8px;
        border-radius: 8px;
        overflow: auto;
        white-space: pre;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin: 10px 0;
      }

      th,
      td {
        border-bottom: 1px solid #e5e7eb;
        padding: 6px;
        vertical-align: top;
      }

      th {
        text-align: left;
        font-weight: 600;
      }

      .empty {
        color: #6b7280;
        font-size: 12px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <div id="cy"></div>
      <div class="panel">
        <h1 class="title">Sankhya API Map</h1>
        <div id="meta" class="muted"></div>
        <div id="details" class="empty">Select an endpoint node to see details.</div>
      </div>
    </div>

    <script>
      function hashString(str) {
        // Simple deterministic hash for stable colors across refreshes.
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = (hash << 5) - hash + str.charCodeAt(i);
          hash |= 0;
        }
        return hash;
      }

      function colorForTag(tag) {
        const t = typeof tag === 'string' ? tag.trim() : '';
        if (!t) return '#60a5fa';
        const hue = Math.abs(hashString(t)) % 360;
        // Cytoscape reliably supports the comma-separated HSL syntax.
        return `hsl(${hue}, 70%, 55%)`;
      }

      function esc(s) {
        return String(s)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      function renderParamsTable(params) {
        if (!params || params.length === 0) return '<div class="empty">No query parameters.</div>';
        const rows = params
          .map(
            (p) =>
              `<tr><td>${esc(p.name)}</td><td>${p.required ? 'yes' : 'no'}</td><td>${esc(p.description || '')}</td></tr>`
          )
          .join('');
        return `<table><thead><tr><th>Name</th><th>Required</th><th>Description</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      function renderResponseExamples(examples) {
        if (!examples || examples.length === 0) return '<div class="empty">No response examples found in spec.</div>';
        return examples
          .map((e) => {
            const header = `<div class="kv"><span class="badge">${esc(e.status)}</span> ${esc(e.description || '')}</div>`;
            const body = `<div class="code">${esc(JSON.stringify(e.example, null, 2))}</div>`;
            return `${header}${body}`;
          })
          .join('<div style="height:10px"></div>');
      }

      async function main() {
        const res = await fetch('../data/endpoints.json');
        const dataset = await res.json();

        const info = dataset.info || {};
        const metaEl = document.getElementById('meta');
        metaEl.textContent = `${info.title || 'OpenAPI'}${info.version ? ' â€¢ ' + info.version : ''}`;

        const nodes = dataset.endpoints.map((e) => {
          const primaryTag = Array.isArray(e.tags) && e.tags.length ? String(e.tags[0] ?? '') : '';
          return {
            data: {
              id: e.id,
              label: `${e.method} ${e.path}`,
              endpoint: e,
              tag: primaryTag,
              color: colorForTag(primaryTag),
            },
          };
        });

        const edges = (dataset.edges || []).map((e, idx) => ({
          data: {
            id: `edge-${idx}`,
            source: e.source,
            target: e.target,
            type: e.type,
          },
        }));

        const cy = cytoscape({
          container: document.getElementById('cy'),
          elements: { nodes, edges },
          layout: { name: 'cose', animate: false, fit: true, padding: 20 },
          style: [
            {
              selector: 'node',
              style: {
                'background-color': 'data(color)',
                label: 'data(label)',
                color: '#e5e7eb',
                'font-size': 9,
                'text-wrap': 'wrap',
                'text-max-width': 140,
              },
            },
            {
              selector: 'edge',
              style: {
                width: 1,
                'line-color': '#334155',
                'target-arrow-shape': 'triangle',
                'target-arrow-color': '#334155',
                'curve-style': 'bezier',
                opacity: 0.7,
              },
            },
            {
              selector: 'node:selected',
              style: {
                'background-color': '#f59e0b',
              },
            },
          ],
        });

        const details = document.getElementById('details');

        cy.on('select', 'node', (evt) => {
          const ep = evt.target.data('endpoint');
          const tags = (ep.tags || []).map((t) => `<span class="badge">${esc(t)}</span>`).join('');

          details.innerHTML = `
            <div class="kv"><span class="badge">${esc(ep.method)}</span> <b>${esc(ep.path)}</b></div>
            <div class="kv">${esc(ep.summary || '')}</div>
            <div class="kv muted">${esc(ep.description || '')}</div>
            <div class="kv">${tags || '<span class="muted">No tags</span>'}</div>
            <h2 class="title" style="margin-top:14px">Query parameters</h2>
            ${renderParamsTable(ep.queryParams)}
            <h2 class="title" style="margin-top:14px">Response examples</h2>
            ${renderResponseExamples(ep.responseExamples)}
          `;
        });

        cy.on('unselect', 'node', () => {
          if (cy.$('node:selected').length === 0) {
            details.textContent = 'Select an endpoint node to see details.';
            details.className = 'empty';
          }
        });
      }

      main().catch((err) => {
        const details = document.getElementById('details');
        details.className = 'empty';
        details.textContent = String(err);
      });
    </script>
  </body>
</html>
